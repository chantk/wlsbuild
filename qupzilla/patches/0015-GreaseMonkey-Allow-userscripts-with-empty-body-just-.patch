From 93c0b7a9e2581ce333fb710b3bfbd4b705a0a54d Mon Sep 17 00:00:00 2001
From: David Rosca <nowrep@gmail.com>
Date: Thu, 28 May 2015 10:06:41 +0200
Subject: [PATCH 15/36] GreaseMonkey: Allow userscripts with empty body (just
 metadata header)

Conflicts:
	src/plugins/GreaseMonkey/gm_script.cpp
---
 src/plugins/GreaseMonkey/gm_script.cpp            | 18 +++++++++---------
 src/plugins/GreaseMonkey/settings/gm_settings.cpp |  4 +---
 2 files changed, 10 insertions(+), 12 deletions(-)

diff --git a/src/plugins/GreaseMonkey/gm_script.cpp b/src/plugins/GreaseMonkey/gm_script.cpp
index 7aacb06..9308fc1 100644
--- a/src/plugins/GreaseMonkey/gm_script.cpp
+++ b/src/plugins/GreaseMonkey/gm_script.cpp
@@ -163,14 +163,8 @@ void GM_Script::watchedFileChanged(const QString &file)
 
 void GM_Script::parseScript()
 {
-    QFile file(m_fileName);
-    if (!file.open(QFile::ReadOnly)) {
-        qWarning() << "GreaseMonkey: Cannot open file for reading" << m_fileName;
-        return;
-    }
-
     m_name.clear();
-    m_namespace = "GreaseMonkeyNS";
+    m_namespace = QSL("GreaseMonkeyNS");
     m_description.clear();
     m_version.clear();
     m_include.clear();
@@ -181,13 +175,19 @@ void GM_Script::parseScript()
     m_enabled = true;
     m_valid = false;
 
+    QFile file(m_fileName);
+    if (!file.open(QFile::ReadOnly)) {
+        qWarning() << "GreaseMonkey: Cannot open file for reading" << m_fileName;
+        return;
+    }
+
     if (!m_fileWatcher->files().contains(m_fileName)) {
         m_fileWatcher->addPath(m_fileName);
     }
 
     QString fileData = QString::fromUtf8(file.readAll());
 
-    QzRegExp rx("// ==UserScript==(.*)// ==/UserScript==");
+    QzRegExp rx(QSL("// ==UserScript==(.*)// ==/UserScript=="));
     rx.indexIn(fileData);
     QString metadataBlock = rx.cap(1).trimmed();
 
@@ -277,5 +277,5 @@ void GM_Script::parseScript()
     script = jscript.arg(nspace, script);
 
     m_script = script;
-    m_valid = !script.isEmpty();
+    m_valid = true;
 }
diff --git a/src/plugins/GreaseMonkey/settings/gm_settings.cpp b/src/plugins/GreaseMonkey/settings/gm_settings.cpp
index 9f6eb00..5f55b6d 100644
--- a/src/plugins/GreaseMonkey/settings/gm_settings.cpp
+++ b/src/plugins/GreaseMonkey/settings/gm_settings.cpp
@@ -117,9 +117,7 @@ void GM_Settings::newScript()
                                 "// @description Script description \n"
                                 "// @include     * \n"
                                 "// @version     1 \n"
-                                "// ==/UserScript==\n"
-                                "\n"
-                                "// Your script implementation\n");
+                                "// ==/UserScript==\n\n");
 
     const QString fileName = QSL("%1/%2.user.js").arg(m_manager->scriptsDirectory(), QzTools::filterCharsFromFilename(name));
 
-- 
2.5.1

